\chapter{\texorpdfstring{$\ell$}{ℓ}-adic representations attached to elliptic
curves}\label{ch:iv}
\chaptermark{Elliptic curves}

Let $K$ be a number field and let $E$ be an elliptic curve over $K$.
\dpage
If $\ell$ is a prime number, let
\[
	\rho_\ell \colon \Gal(\algcl K/K) \longrightarrow \Aut(V_\ell(E))
\]
be the corresponding $\ell$-adic representation of $K$, cf.\ chap.~\ref{ch:i},
\ref{sec:I_12}.  The main result of this Chapter is the determination of the
Lie algebra of the $\ell$-adic Lie group $G_\ell = \Img(\rho_\ell)$. This is
based on a finiteness theorem of \v Safarevi\v c (\ref{sec:IV_14}) combined
with the properties of locally algebraic abelian representations
(chap.~\ref{ch:iii}) and Tate's local theory of elliptic curves with
non-integral modular invariant (Appendix, \ref{sec:IV_A1}). The variation of
$G_\ell$ with $\ell$ is studied in \S\ref{sec:IV_3}.

The Appendix gives analogous results in the local case (i.e.\ when $K$ is a
local field).

\section{Preliminaries}%
\dpage

\subsection[Elliptic curves]{Elliptic curves \textmd{(cf.\
\citeauthor{5}~\cite{5}, \citeauthor{9}~\cite{9}, \citeauthor{10}~\cite{10})}}
\label{sec:IV_11}
By an elliptic curve, we mean an abelian variety of dimension
1, i.e.\ a complete, non singular, connected curve of genus 1 with a
given rational point $P_0$, taken as an origin for the composition law
(and often written $o$).

Let $E$ be such a curve. It is well known that $E$ may be embedded, as a
non-singular cubic, in the projective plane $\PP^2_K$, in such a way that $P_0$
becomes a \textquote{flex} (one takes the projective embedding defined by the
complete linear series containing the divisor $3\cdot P_0$). In this embedding,
three points $P_1$, $P_2$, $P_3$ have sum $0$ if and only if the divisor $P_1 +
P_2 + P_3$ is the intersection of $E$ with a line. By choosing a suitable
coordinate system, the equation of $E$ can be written in Weierstrass form
\[
	y^2 = 4x^3 - g_2x - g_3
\]
where $x$, $y$ are non-homogeneous coordinates and the origin $P_0$ is
the point at infinity on the $y$-axis. The discriminant
\[
	\Delta = g_2^3 - 27g_3^2
\]
is non-zero.

The coefficients $g_2$, $g_3$ are determined up to the transformations $g_2
\mapsto u^4 g_2$, $g_3 \mapsto u^6 g_3$, $u \in K^\times$. The modular
invariant $j$ of $E$ is
\[
	j = 2^6 \, 3^3 \, \frac{g_2^3}{g_2^3 - 27g_3^2}
	= 2^6 \, 3^3 \, \frac{g_2^3}{\Delta}.
\]
\dpage
Two elliptic curves have the same $j$ invariant if and only if they become
isomorphic over the algebraic closure of $K$.

(All this remains valid over an arbitrary field, except that, when the
characteristic is 2 or 3, the equation of $E$ has to be written in the more
general form
\[
	y^2 + a_1xy + a_3y + x^3 + a_2x^2 + a_4x + a_6 = 0.
\]
Here again, 0 is the point at infinity on the $y$-axis and the 
corresponding tangent is the line at infinity. There are corresponding
definitions for $\Delta$ and $j$, for which we refer to \citeauthor{9}~\cite{9}
or \citeauthor{20}~\cite{20}; note, however, that there is a misprint in Ogg's
formula for $\Delta$: the coefficient of $\beta_4^3$ should be $-8$ instead of
$-1$.)

\subsection{Good reduction}
\label{sec:IV_12}
Let $v \in M_K^0$ be a finite place of the number field $K$. We denote by
$\mathcal{O}_v$ (resp.\ $\mathfrak{m}_v$, $k_v$) the corresponding local ring
in $K$ (resp.\ its maximal ideal, its residue field).

Let $E$ be an elliptic curve over $K$. One says that $E$ has \strong{good
reduction at $v$} if one can find a coordinate system in $\PP^2_K$ such that
the corresponding equation $f$ for $E$ has coefficient in $\mathcal{O}_v$ and
its reduction $\tilde f \mod{\mathfrak{m}_v}$ defines a non-singular cubic
$\widetilde{E}_v$ (hence an elliptic curve) over the residue field $k_v$ (in
other words, the discriminant $\Delta(f)$ of $f$ must be an invertible element
of $\mathcal{O}_v$).
The curve $\widetilde{E}_v$ is called the \strong{reduction} of $E$ at $v$;
\dpage
it does not depend on the choice of $f$, provided, of course, that $\Delta(f) \in
\mathcal{O}_v^\times$.

One can prove that the above definition is equivalent to the following one:
there is an abelian scheme $E_v$ over $\Spec(\mathcal{O}_v)$, in the sense of
\citeauthor{19}~\cite{19}, chap.\ VI, whose generic fiber is $E$; this scheme
is then unique, and its special fiber is $\widetilde{E}_v$. Note that
$\widetilde{E}_v$ is defined over the finite field $k_v$; we denote its
\strong{Frobenius endomorphism} by $F_v$.

On either definition, one sees that $E$ has \strong{good reduction for
almost all places of $K$}.

If $E$ has good reduction at a given place $v$, its $j$ invariant is
\strong{integral at $v$} (i.e.\ belongs to $\mathcal{O}_v$) and its reduction
$\tilde\jmath \mod{\mathfrak{m}_v}$ is the $j$ invariant of the reduced curve
$\widetilde{E}_v$.

The converse is almost true, but not quite: if $j$ belongs to $\mathcal{O}_v$,
there is a finite extension $L$ of $K$ such that $E \otimes_K L$ has good
reduction at all the places of $L$ dividing $v$ (this is the ``potential good
reduction'' of \citeauthor{32}~\cite{32}, \S 2). For the proof of this, see
\citeauthor{29}~\cite{29}, \S 4, n\textsuperscript{o}~3.

\begin{obs}
The definitions and results of this section have nothing to do with number
fields. They apply to every field with a discrete valuation.
\end{obs}

\subsection{Properties of \texorpdfstring{$V_\ell$}{Vℓ} related to good
reduction}\label{sec:IV_13}
Let $\ell$ be a prime number. We define, as in chap.~\ref{ch:i},
\ref{sec:I_12}, the Galois modules $T_\ell$ and $V_\ell$ by:
\[
	V_\ell = T_\ell \otimes \Q_\ell, \qquad T_\ell = \invlim_n E_{\ell^n}
\]
where $E_{\ell^n}$ is the kernel of $\ell^n \colon E(\algcl K) \to E(\algcl K)$.
\dpage

We denote by $\rho_\ell$ the corresponding homomorphism of $\Gal(\algcl K/K)$
into $\Aut(T_\ell)$. Recall that $E_{\ell^n}$, $T_\ell$ and $V_\ell$ are of
rank 2 over $\Z/\ell^n\Z$, $\Z_\ell$ and $\Q_\ell$, respectively.

Let now $v$ be a place of $K$, with $p_v \ne \ell$ and let $v$ be some
extension of $v$ to $\algcl K$; let $D$ (resp.\ $I$) be the corresponding
decomposition group (resp.\ inertia group), cf.\ chap.~\ref{ch:i},
\ref{sec:I_21}. If $E$ has good reduction at $v$, one easily sees that
reduction at $v$ defines an \emph{isomorphism} of $E_{\ell^n}$ onto the
corresponding module for the reduced curve $\widetilde{E}_v$. In particular,
$E_{\ell^n}$, $T_\ell$, $V_\ell$ are \emph{unramified at $v$}
(chap.~\ref{ch:i}, \ref{sec:I_21}) and the Frobenius automorphism $F_{v,
\rho_\ell}$ of $T_\ell$ corresponds to the Frobenius endomorphism $F_v$ of
$\widetilde{E}_v$. Hence: 
\[
	\det(F_{v, \rho_\ell}) = \det(F_v) = \numnorm v
\]
and
\[
	\det(1 - F_{v, \rho_\ell}) = \det(1 - F_v) = 1 - \tr(F_v) + \numnorm v
\]
is equal to the number of $k_v$-points of $\widetilde{E}_v$.

Conversely:
\begin{thm}[Criterion of Néron-Ogg-\v Safarevi\v c]
If $V$ is unramified at $v$ for some $\ell \ne p_v$, then $E$ has good
reduction at $v$.
\end{thm}
For the proof, see \citeauthor{32}~\cite{32}, \S 1.

\begin{cor}
Let $E$ and $E'$ be two elliptic curves which are isogenous (over $K$). If one
of them has good reduction at a place $v$, the same is true for the other one.
\end{cor}
(Recall that $E$ and $E'$ are said to be \strong{isogenous} if there
\dpage
exists a non-trivial morphism $E \to E'$.)

This follows from the theorem, since the $\ell$-adic representations associated
with $E$ and $E'$ are isomorphic.

\begin{obs}
For a direct proof of this corollary, see \citeauthor{11}~\cite{11}.
\end{obs}

\subsubsection*{Exercise}
Let $S$ be the finite set of places where $E$ does not have good reduction. If
$v \in M_K^0 \setminus S$, we denote by $t_v$ the number of $k_v$-points of the
reduced curve $\widetilde{E}_v$.
\begin{enumerate}[(a)]
	\item Let $\ell$ be a prime number and let $m$ be a positive integer.
		Show that the following properties are equivalent:
	\begin{enumerate}[(i)]
		\item\label{exr:cebotarev_i}
			$t_v \equiv 0 \mod{\ell^m}$ for all $v \in M_K^0 \setminus S$, $p_v \ne \ell$.
		\item\label{exr:cebotarev_ii}
			The set of $v \in M_K^0 \setminus S$ such that $t_v
			\equiv 0 \mod{\ell^m}$ has density one (cf.\ 
			chap.~\ref{ch:i}, \ref{sec:I_22}).
		\item\label{exr:cebotarev_iii}
			For all $s \in \Img(\rho)$, one has $\det(1-s) \equiv 0 \mod{\ell^m}$.
	\end{enumerate}
	(The equivalence of \ref{exr:cebotarev_ii} and \ref{exr:cebotarev_iii}
	follows from \v Cebotarev's density theorem. The implications
	\ref{exr:cebotarev_i} $\implies$ \ref{exr:cebotarev_ii} and
	\ref{exr:cebotarev_iii} $\implies$ \ref{exr:cebotarev_i} are easy.)

	\item We take now $m = 1$. Show that the properties
		\ref{exr:cebotarev_i}, \ref{exr:cebotarev_ii} and
		\ref{exr:cebotarev_iii} are equivalent to:
	\begin{enumerate}[resume*]
		\item\label{exr:cebotarev_iv}
			There exists an elliptic curve $E'$ over $K$ such that:
		\begin{itemize}
			\item[$(\alpha)$]
				Either $E'$ is isomorphic to $E$, or there
				exist an isogeny $E' \to E$ of degree $\ell$.
			\item[$(\beta)$]
				The group $E'(K)$ contains an element of order
				$\ell$.
		\end{itemize}
	\end{enumerate}
	(The implication \ref{exr:cebotarev_iv} $\implies$
	\ref{exr:cebotarev_iii} is easy. For the proof of the converse, use
	Exer.~\ref{ex:I11_ex2} of chap.~\ref{ch:i}, \ref{sec:I_11}.)
	[For $m > 2$, see \citeauthor{64}~\cite{64}.]
\end{enumerate}

\subsection{\v Safarevi\v c's theorem}%
\label{sec:IV_14}
\dpage
It is the following (cf.\ \cite{23}):
\begin{thm}
Let $S$ be a finite set of places of $K$. The set of isomorphism classes of
elliptic curves over $K$, with good reduction at all places not in $S$, is
finite.
\end{thm}
Since isogenous curves have the same bad reduction set (cf.\ \ref{sec:IV_13}),
this implies:
\begin{cor}
Let $E$ be an elliptic curve over $K$. Then, up to isomorphism, there are only
a finite number of elliptic curves which are $K$-isogenous to $E$.
\end{cor}

To prove the theorem, we use the following criterion for good reduction:
\begin{lem}
Let $S$ be a finite set of places of $K$ containing the divisors of 2 and 3,
and such that the ring $\mathcal{O}_S$ of $S$-integers is principal. Then, an
elliptic curve $E$ defined over $K$ has good reduction outside $S$ if and only
if its equation can be put in the Weierstrass form $y^2 = 4x^3 - g_2 x - g_3$
with $g_i \in \mathcal{O}_S$ and $\Delta = g_2^3 - 27 g_2^3 \in
\mathcal{O}_S^\times$ (the group of units of $\mathcal{O}_S$).
\end{lem}

\begin{proof}
The sufficiency is trivial. To prove necessity, we write the
curve $E$ in the form
\begin{equation}
	y^2 = 4x^3 - g_2^\prime x - g_3^\prime
	\tag{$*$}
	\label{eq:safarevich_lemma}
\end{equation}
with $g_i^\prime \in K$. Let $v$ be a place of $K$ not in $S$. Then, since
there is good reduction at $v$, and since the divisors of 2 and 3 do not belong
\dpage
to $S$, the curve $E$ can be written in the form
\[
	y^2 = 4x^3 - g_{2, v}^\prime x - g_{3, v}^\prime
\]
with $g_{i, v}$ in the local ring at $v$ and the discriminant $\Delta_v$ a unit
in this ring. Using the properties of the Weierstrass form, there is an element
$u_v \in K$ such that $g_{2, v} = u_v^4 g^\prime_2$, $g_{3, v} = u_v^6
g^\prime_3$, $\Delta_v = u_v^{12} \Delta'$;\label{errata:uv12} moreover, as we
can take $g_{i,v} = g_i^\prime$ for almost all $v$, we see that we can assume
that $u_v = 1$ for almost all $v \notin S$. Since the ring $\mathcal{O}_S$ is
principal, there is an element $u \in K^\times$ with $v(u) = v(u_v)$ for all $v
\notin S$. Then, if we replace $x$ by $u^{-2} x$ and $y$ by $u^{-3} y$ in
\eqref{eq:safarevich_lemma}, the curve $E$ takes the form
\[
	y^2 = 4x^3 - g_2^\prime x - g_3^\prime
\]
with $g_2 = u^4 g^\prime_2$, $g_3 = u^6 g^\prime_3$ and $\Delta = u^{12}
\Delta'$. Since, by construction, $g_i \in \mathcal{O}_S$ and $\Delta \in
\mathcal{O}_S^\times$ the lemma is established.
\end{proof}

\begin{proof}[ of the theorem]
After possibly adding a finite number of places of $K$ to $S$, we may assume
that $S$ contains all the divisors of 2 and 3, and that the ring
$\mathcal{O}_S$ is principal. If $E$ is an elliptic curve defined over $K$
having good reduction outside $S$, the above lemma tells us that we can write
$E$ in the form
\begin{equation}
	y^2 = 4x^3 - g_2^\prime x - g_3^\prime
	\tag{$*$}
	\label{eq:wei_form_star2}
\end{equation}
with $g_i \in \mathcal{O}_S$ and $\Delta = g_2^3 - 27 g_2^3 \in \mathcal{O}_S$.
But, since we are free to multiply $\Delta$ by any $u \in
{(\mathcal{O}_S^\times)}^{12}$, and since
$\mathcal{O}_S^\times/{(\mathcal{O}_S^\times)}^{12}$ is a finite group, we see
that there is a finite set $X \subset \mathcal{O}_S^\times$ such that any
elliptic
\dpage
curve of the above type can be written in the form \eqref{eq:wei_form_star2}
with $g_i \in \mathcal{O}_S$ and $\Delta \in X$. But, for a given $\Delta$, the
equation
\[
	U^3 - 27V^2 = \Delta
\]
represents an affine elliptic curve. Using a theorem of Siegel (generalized by
Mahler and Lang, cf.\ \citeauthor{14}~\cite{14}, chap.~VII), one sees that this
equation has only a \emph{finite} number of solutions in $\mathcal{O}_S$. This
finishes the proof of the theorem.
\end{proof}

\begin{obs}
There are many ways in which one can deduce \v Safarevi\v c's theorem from
Siegel's. The one we followed has been shown to us by Tate.
\end{obs}

\section{The Galois module attached to $E$}
In this section, $E$ denotes an elliptic curve over $K$. We are
interested in the structure of the Galois modules $E_{\ell^n}$, $T_\ell$, $V_\ell$
defined in \ref{sec:IV_13}.

\subsection{The irreducibility theorem}
\label{sec:IV_21}
Recall first that the ring $\End_K(E)$ of $K$-endomorphisms of $E$
is either $\Z$ or of rank 2 over $\Z$. In the first case, we say that $E$
has ``no complex multiplication over $K$.'' If the same is true for any
finite extension of $K$, we say that $E$ has ``no complex 
multiplication.''

\begin{thm}
Assume that $E$ has no complex multiplication over $K$.
\dpage
Then:
\begin{enumerate}[(a)]
\item\label{thm:IV_21_a} $V_\ell$ is irreducible for all primes $\ell$;
\item $E_\ell$ is irreducible for almost all primes $\ell$.
\end{enumerate}
\end{thm}

We need the following elementary result:
\begin{lem}
Let $E$ be an elliptic curve defined over $K$ with $\End_K(E) = \Z$. Then, if
$E' \to E$, $E'' \to E$ are $K$-isogenies with non-isomorphic cyclic kernels,
the curves $E'$ and $E''$ are non-isomorphic over $K$.
\end{lem}
\begin{proof}
Let $n'$ and $n''$ be respectively the orders of the kernels of
$E' \to E$ and $E'' \to E$. Suppose that $E'$ and $E''$ are isomorphic
over $K$, and let $E' \to E''$ be an isomorphism. If $E \to E'$ is the
transpose of the isogeny $E' \to E$, it has a cyclic kernel of order
$n'$, and hence the isogeny $E \to E$, obtained by composition of
$E \to E'$, $E' \to E''$, $E'' \to E$, has for kernel an extension of
$\Z/n''\Z$ by $\Z/n'\Z$. But, since $\End_K(E) = \Z$, this isogeny must be
multiplication by an integer $a$, and its kernel must therefore be of
the form $\Z/a\Z \times \Z/a\Z$. Hence $n'$ and $n''$ divide $a$. Since
$a^2 = n'n''$, we obtain $a = n' = n''$, a contradiction.
\end{proof}

\begin{proof}[ of the theorem]
\begin{enumerate}[(a)]
\item It suffices to show that, if $\End_K(E) = \Z$, there is no
	one-dimensional $\Q_\ell$-subspace of $V_\ell$ stable under
	$\Gal(\algcl K/K)$. Suppose there were one; its intersection $X$ with
	$T_\ell$ would be a submodule of $T_\ell$ with $X$ and $T_\ell/X$ free
	$Z_\ell$-modules of rank 1. For $n \ge 0$, consider the image $X(n)$ of
	$X$ in $E_{\ell^n} = T/\ell^n T$. This is a submodule of $E_\ell$ which
	is cyclic of order $\ell^n$ and stable by $\Gal(\algcl K/K)$. Hence it
	corresponds to a finite $K$-algebraic subgroup of
	\dpage
	$E$ and one can define the quotient curve $E(n) = E/X(n)$. The kernel
	of the isogeny $E \to E(n)$ is cyclic of order $\ell^n$. The above
	lemma then shows that the curves $E(n)$, $n \ge 0$, are pairwise
	non-isomorphic, contradicting the corollary to \v Safarevi\v c's
	theorem (\ref{sec:IV_14}).
\item If $E$ is not irreducible, there exists a Galois submodule $X$ of $E$
	which is one-dimensional over $\F_\ell$. In the same way as above, this
	defines an isogeny $E \to E/X_\ell$ whose kernel is cyclic of order
	$\ell$. The above lemma shows that the curves which correspond to
	different values of $\ell$ are\break non-isomorphic, and one again applies
	the corollary to \v Safarevi\v c's\break theorem.
	\qedhere
\end{enumerate}
\end{proof}

\begin{obs}
One can prove part \ref{thm:IV_21_a} of the above theorem by a quite different
method (cf.\ \cite{25}, \S 3.4); instead of the \v Safarevi\v c's theorem, one
uses the properties of the decomposition and inertia subgroups of
$\Img(\rho_\ell)$, cf.\ Appendix.
\end{obs}

\subsection{Determination of the Lie algebra of \texorpdfstring{$G_\ell$}{Gℓ}}
\label{sec:IV_22}
Let $G_\ell = \Img(\rho_\ell)$\index{Gl@$G_\ell$} denote the image of $\Gal(\algcl K/K)$ in
$\Aut(T_\ell)$, and let $\mathfrak{g}_\ell \subset \End(V_\ell)$ be the Lie
algebra of $G_\ell$.

\begin{thm}
	If $E$ has no complex multiplication (cf.\ \ref{sec:IV_21}), then
	$\mathfrak{g}_\ell = \End(V_\ell)$, i.e.\ $G_\ell$ is open in
	$\Aut(T_\ell)$.
\end{thm}
\begin{proof}
	The irreducibility theorem of \ref{sec:IV_21} shows that, for any open
	subgroup $U$ of $G_\ell$, $V_\ell$ is an irreducible $U$-module. Hence,
	$V_\ell$ is an irreducible $\mathfrak{g}_\ell$-module. By Schur's
	lemma, it follows that the commuting algebra $\mathfrak{g}^\prime_\ell$
	of $\mathfrak{g}_\ell$ in $\End(V_\ell)$ is a field; since $\dim V_\ell
	= 2$, this field is either $\Q_\ell$ or a quadratic extension of
	$\Q_\ell$.  If $\mathfrak{g}^\prime_\ell = \Q_\ell$, then
	$\mathfrak{g}_\ell$ is equal to either $\End(V_\ell)$, or the
	subalgebra $\Sl(V_\ell)$
	\dpage
	% \todo[pinktask]{Revisar si $\Sl(V)$ es la notación adecuada.}
	of $\End(V_\ell)$ consisting of the endomorphisms with trace 0; but, in
	the second case, the action of $\mathfrak{g}_\ell$ on $\bigwedge^2
	V_\ell$ would be trivial, and this would contradict the fact that the
	Galois modules $\bigwedge^2 V_\ell$ and $V_\ell(\mu)$ are isomorphic
	(chap.~\ref{ch:i}, \ref{sec:I_12}). Hence $\mathfrak{g}_\ell =
	\Sl(V_\ell)$ is impossible.

	Suppose now that $\mathfrak{g}_\ell^\prime$ is a quadratic extension of
	$\Q_p$. Then $V_\ell$ is a one-dimensional
	$\mathfrak{g}_\ell^\prime$-vector space and the commuting algebra of
	$\mathfrak{g}_\ell^\prime$ in $\End(V_\ell)$ is
	$\mathfrak{g}_\ell^\prime$ itself. Hence $\mathfrak{g}_\ell$ is
	contained in $\mathfrak{g}_\ell^\prime$, and is \emph{abelian}
	($\mathfrak{g}_\ell^\prime$ is a ``non-split Cartan algebra'' of
	$\End(V_\ell)$).  After replacing $K$ by a finite extension (this does
	not affect $\mathfrak{g}_\ell$, cf.\ chap.~\ref{ch:i}, \ref{sec:I_11}),
	we may then suppose that $G_\ell$ itself is abelian. The $\ell$-adic
	representation $V_\ell$ is then semi-simple, abelian and rational.  It
	is, moreover, \emph{locally algebraic}. To see this, we first remark
	that, at a place $v$ dividing $\ell$, we have $v(j) \ge 0$ since
	otherwise the decomposition group of $v$ in $G_\ell$ would be
	non-abelian by Tate's theory (cf.\ Appendix, \ref{sec:IV_A13}); hence,
	after a finite extension of $K$, we can assume that $E$ has good
	reduction at all places $v$ dividing $\ell$ (cf.\ \ref{sec:IV_12}). Let
	$E(\ell)$ be the $\ell$-divisible group attached to $E$ at $v$ (cf.\ 
	\citeauthor{39}~\cite{39}, 2.1, example~(a)). We have $V_\ell \cong
	V_\ell(E(\ell))$ and this module is known to be of Hodge-Tate type
	(\emph{loc. cit.}, \S 4). Using another result of Tate
	(chap.~\ref{ch:iii}, \ref{sec:III_12}), this implies that the
	representation $V_\ell$ is locally algebraic, as claimed above. (This
	could also be seen by using, instead of the theory of Hodge-Tate
	modules, the local results of the Appendix, \ref{sec:IV_A2}.)

	We may now apply to $V_\ell$ the results of chap.~\ref{ch:iii},
	\ref{sec:III_23}.  Hence, there is, for each prime $\ell'$, a rational,
	abelian, semi-simple $\ell'$-adic representation $W_{\ell'}$ compatible
	with $V_\ell$. But $V_{\ell'}$ is compatible with $V_\ell$, and
	$V_{\ell'}$ is semi-simple. Hence $V_{\ell'}$, is isomorphic to
	$W_{\ell'}$ (cf.\ chap.~\ref{ch:i}, \ref{sec:I_23}). But we know
	(chap.~\ref{ch:iii}, \ref{sec:III_23}) that we may choose $\ell'$ such
	\dpage
	that $W_{\ell'}$ is the direct sum of one-dimensional subspaces stable
	under $\Gal(\algcl K/K)$. This contradicts the irreducibility of
	$V_\ell$. Hence, we must have $\mathfrak{g}_\ell^\prime = \Q_p$ and
	$\mathfrak{g}_\ell = \End(V_\ell)$.
\end{proof}

\begin{obs}
	If $E$ has complex multiplication, and $L = \Q \otimes \End(E \otimes_K
	\algcl K)$ is the corresponding imaginary quadratic field, one shows
	easily that $\mathfrak{g}_\ell$ is the Cartan subalgebra of
	$\End(V_\ell)$ defined by $L_\ell = \Q_\ell \otimes L$. It splits if and
	only if $\ell$ decomposes in $L$.
\end{obs}

\subsubsection*{Exercises}
(In these exercises, we assume $E$ has no complex multiplication. Let $S$ be
the set of places $v \in M_K^0$ where $E$ has bad reduction. If $v \in M_K^0
\setminus S$, we denote by $F_v$ the Frobenius endomorphism of the reduced
curve $\widetilde{E}_v$; if $\ell \ne p_v$, we identify $F_v$ to the
corresponding automorphism of $T_\ell$.)

\begin{enumerate}
\item Let $H(X, Y)$ be a polynomial in two indeterminates $X$, $Y$ with
	coefficients in a field of characteristic zero. Let $V_H$ be the set of
	those $v \in M_K^0 \setminus S$ for which $H(\Tr(F_v), \numnorm v) =
	0$. If $H$ is not the zero polynomial, show that $V_H$ has density 0.
	(Show that the set of $g \in \GL(2, \Z_\ell)$ with $H(\Tr(g), \det(g)) =
	0$ has Haar measure zero.)

\item The eigenvalues of $F_v$ may be identified with complex numbers of the
	form
	\[
		(\numnorm v)^{1/2} e^{\pm i \varphi_v},
		\qquad 0 \le \varphi_v \le \pi,
	\]
	cf.\ chap.~\ref{ch:i}, Appendix~\ref{sec:I_A2}. Show that the set of
	$v$ for which $\varphi_v$ is a given angle $\varphi$ has density zero.
	(Show that $\Tr(F_v)^2 = 4(\numnorm v)\cos^2 \varphi$ and then use the
	preceding exercise.)

\item Let $L_v = \Q(F_v)$ be the field generated by $F_v$. By the preceding
	\dpage
	exercise, $L_v$ is quadratic imaginary except for a set of $v$ of
	density 0.
	\begin{enumerate}
	\item\label{ex:IV_22_3a} Let $\ell$ be a fixed prime. Let $C$ be a semi-simple commutative
		$\Q_\ell$-algebra of rank 2. Let $X_C$ be the set of elements
		$s \in \Aut(V_\ell)$ such that the subalgebra $\Q_\ell[s]$ of
		$\End(V_\ell)$ generated by $s$ is isomorphic to $C$. Show that
		$X_C$ is open in $\Aut(V_\ell)$, and show that it has a
		non-empty intersection with every open subgroup of
		$Aut(V_\ell)$, in particular, with $G_\ell$.
	\item Show that $F_v \in X_C$ if and only if the field $L_v$ is
		quadratic and $L_v \otimes \Q_\ell$ is isomorphic to $C$.
	\item Let $\ell_1, \dots, \ell_n$ be distinct prime numbers, and choose
		for each an algebra $C_i$ of the type considered in
		\ref{ex:IV_22_3a}. Show that the set of $v$ for which $F_v \in
		X_C$ for $i = 1, \dots, n$ has density $> 0$.

		(Use the fact that the image of $\Gal(\algcl K/K)$ in any
		finite product of the $\Aut(V_\ell)$ is open; this is an easy
		consequence of the theorem proved above.)
	\item Deduce that, for any finite set $P$ of prime numbers, there exist
		an infinity of $v$ such that $L_v$ is ramified at all $\ell \in
		P$. In particular, there are an infinite number of distinct
		fields $L_v$.
	\end{enumerate}
\end{enumerate}

\subsection{The isogeny theorem}
\label{sec:IV_23}
\todo[section]{Belen.}

\section{Variation of \texorpdfstring{$G_\ell$}{Gℓ} and
\texorpdfstring{$\widetilde{G}_\ell$}{Ḡℓ} with \texorpdfstring{$\ell$}{ℓ}}

\subsection{Preliminaries}
\label{sec:IV_31}
\todo[section]{Belen.}

\subsection{The case of a non integral $j$}
\label{sec:IV_32}
\dpage
\begin{thm}
	Assume that the modular invariant $j$ of $E$ is not an integer of $K$.
	Then $E$ enjoys the equivalent properties (i), (ii), (iii), (iv) of
	\ref{sec:IV_31}.
\end{thm}
Since $j$ is not integral, we can choose a place $v$ of $K$ such
that $v(j) < 0$. Let $q$ be the element of the local field $K$ which
corresponds to $j$ by Tate's theory (cf.\ Appendix, \ref{sec:IV_A11}) and let $E$
be the corresponding elliptic curve over $K$. There is a finite
extension $K'$ of $K_v$ over which $E$ and $E_q$ are isomorphic; one
can even take for $K'$ either $K_v$ or a quadratic extension of $K_v$.
Let $v'$ be the valuation of $K'$ which extends $v$; assume $v'$ is
normalized so that $v'({K'}^\times) = \Z$, and let
\[
	n = v'(q) = - v'(j)
\]
We have $n > 1$.

\begin{lem}\label{lem:IV_32_1}
	Assume $\ell$ does not divide $n$, and let $I_{v, \ell}$ be the inertia
	subgroup of $\widetilde{G}_\ell$ corresponding to some extension of $v$
	to $\algcl K$.  Then $I_{v, \ell}$ contains a transvection, i.e.\ an
	element whose matrix form is $
	\begin{psmallmatrix}
		1 & 1 \\
		0 & 1
	\end{psmallmatrix}
	$ for a suitable $\F_\ell$-basis of $E_\ell$.
\end{lem}
This is true for the curve $E_q$ over $K'$, cf.\ Appendix, \ref{sec:IV_A15}.
The result for $E$ follows from the isomorphism $E_{/K'} \cong {E_q}_{/K'}$.

\begin{lem}\label{lem:IV_32_2}
	Let $H$ be a subgroup of $\GL(2, \F_\ell)$ which acts irreducibly on
	$\F_\ell\times\F_\ell$ and which contains a transvection. Then $H$
	contains $\SL(2, \F_\ell)$.
\end{lem}

For any transvection $s \in H$, let $D$ be the unique one dimensional subspace
of $\F_\ell\times\F_\ell$ which is fixed by $s$. If all such lines were the
same, the line so defined would be stable by $H$, and $H$ would not be
irreducible. Hence there are transvections $s, s' \in H$ such that $D_s \ne
D_{s'}$. If we choose a suitable basis $(e,e')$ of $\F_\ell\times\F_\ell$, this
means that the matrix forms of $s$, $s'$ are
\[
	s =
	\begin{pmatrix}
		1 & 1 \\
		0 & 1
	\end{pmatrix}, \qquad s' = 
	\begin{pmatrix}
		1 & 0 \\
		1 & 1
	\end{pmatrix} 
\]
The lemma follows then from the well known fact that these two matrices
generate $\SL(2, \F_\ell)$.

\begin{proof}[ of the theorem]
	Lemma~\ref{lem:IV_32_1} shows that, for almost all $\ell$, $I_{v,
	\ell}$.  and \emph{a fortiori} $\widetilde{G}_\ell$, contains a
	transvection. On the other hand, we know (cf.\ \ref{sec:IV_21}) that
	$\widetilde{G}_\ell$ is irreducible for almost all $\ell$. Applying
	lemma~\ref{lem:IV_32_2} to $\widetilde{G}_\ell$ we then see that
	$\widetilde{G}_\ell$ contains $\SL(E_\ell)$ for almost all $\ell$;
	hence we have (iv).
\end{proof}

\begin{obs}
	It seems likely that the condition ``$j$ is not integral'' can be
	replaced by the weaker one ``$E$ has no complex multiplication.''
	$\to$ [yes: see \cite{76}.]
\end{obs}

\subsection{Numerical example}
\label{sec:IV_33}
\todo[section]{Belen.}

\subsection{Proof of the main lemma of 3.1}
\label{sec:IV_34}
\todo[section]{José.}

\begin{subappendices}

\section{Local results}
\dpage
In what follows, $K$ denotes a field which is complete with respect to a
discrete valuation $v$; we denote by $\mathcal{O}_K$ (resp.\ by $k$) the ring
of integers (resp.\ the residue field) of $K$; we assume that $k$ is perfect
and of characteristic $p \ne 0$.

Let $E$ be an elliptic curve over $K$ and let $\ell$ be a prime number
different from the characteristic of $K$. Let $T_\ell$ and $V_\ell$ be the
corresponding Galois modules; we denote by $G_\ell$ the image of $\Gal(\sepcl
K/K)$ in $\Aut(T_\ell)$, and by $I_\ell$ the inertia subgroup of $G_\ell$. The
Lie algebras $\mathfrak{g}_\ell = \Lie(G_\ell)$, $\mathfrak{i}_\ell =
\Lie(I_\ell)$ are subalgebras of $\End(V_\ell)$ and we will determine them
under suitable assumptions on $K$ and $v$; note that, since $I_\ell$ is an
invariant subgroup of $G_\ell$, its Lie algebra $\mathfrak{i}_\ell$ is an
\emph{ideal} of $\mathfrak{g}_\ell$.

If $j = j(E)$ is the modular invariant of $E$ (cf.\ \ref{sec:IV_11}), we
consider the cases $v(j) < 0$ and $v(j) \ge 0$ separately.

\subsection{The case $v(j) < 0$}
\label{sec:IV_A1}
In this section we assume that the modular invariant $j$ of the elliptic curve
$E$ has a pole, i.e.\ that $v(j) < 0$.

\subsubsection{The elliptic curves of Tate}
\label{sec:IV_A11}
Let $q$ be an element of $K$ with $v(q) > 0$, and let $\Gamma_q$ be the
discrete subgroup of $K^\times$ generated by $q$. Then, by Tate's theory of
ultrametric theta functions (unpublished, but see Morikawa, \emph{Nagoya Math.
Journ.}, 1962),
\todo[bluetask]{Añadir referencia}
\dpage
there is an elliptic curve $E$ defined over $K$ with the property that, for any
finite extension $K'$ of $K$, the analytic group ${K'}^\times / \Gamma_q$ is
isomorphic to the group $E_q(K')$ of points of $E_q$ with values in $K'$. The
equation defining $E_q$ can he written in the form
\[
	y^2 + xy = x^3 - b_2x - b_3,
\]
with
\[
	b_2 = 5 \sum_{n\ge 1} n^3 \, \frac{q^n}{1-q^n}, \qquad \text{and}
	\qquad b_3 = \sum_{n\ge 1} (7n^5 + 5n^3) \frac{q^n}{12(1-q^n)},
\]
these series converging in $K$. The modular invariant $j(q)$ of $E_q$ is
given by the usual formula
\[
	j(q) = \frac{(1 + 48b_2)^3}{q \prod_{n\ge 1} (1 - q^n)^{24}}
	= \frac{1}{q} + 744 + 196\,884 q + \cdots
\]
a series with integral coefficients. The function field of $E_q$ consists
of the fractions $F/G$, where $F$ and $G$ are Laurent series
\[
	F = \sum_{n=-\infty}^{+\infty} a_n z^n, \qquad
	G = \sum_{n=-\infty}^{+\infty} b_n z^n
\]
with coefficients in $K$, converging for all values of $z \ne 0, \infty$, and
such that $F(qz)/G(qz) = F(z)/G(z)$.

Since the modular invariant $j$ of the given elliptic curve $E$
is such that $v(j) < 0$, and since the series for $j(q)$ has integral
coefficients, one can choose $q$ so that $j = j(q)$. The elliptic curves
$E$ and $E_q$ become then isomorphic over a finite extension of $K$
(which can be taken to be of degree 2). Hence, after possibly 
replacing $K$ by a finite extension, \emph{we may assume that $E = E_q$}.

\subsubsection{An exact sequence}
\label{sec:IV_A12}
We conserve the notation of \ref{sec:IV_A11}.
\dpage
Let $E_n$ be the kernel of multiplication by $\ell^n$ in $\sepcl
K^\times/\Gamma_q$. If $\mu_n$ is the group of $\ell^n$-th roots of unity in
$\sepcl K$, we have an injection $\mu_n \to E_n$. On the other hand, if $z \in
E_n$, we have $z^{\ell^n} \in \Gamma_q$, and hence there exists an integer $c$
such that $z^{\ell^n} = q^c$. If we associate to $z$ the image of $c$ in
$\Z/\ell^n\Z$, we obtain a homomorphism of $E_n$ into $\Z/\ell^n\Z$, and the
resulting sequence
\begin{equation}
	\begin{tikzcd}
		0 \rar & \mu_n \rar & E_n \rar & \Z/\ell^n\Z \rar & 0
	\end{tikzcd}
	\label{cd:IV_A2_1}
\end{equation}
is an exact sequence of $\Gal(\sepcl K/K)$-modules, $\Gal(\sepcl K/K)$ acting
trivially on $\Z/\ell^n\Z$. Passing to the limit, we obtain an exact sequence
of Galois modules
\begin{equation}
	\begin{tikzcd}
		0 \rar & T_\ell(\mu) \rar & T_\ell(E_n) \rar & \Z_\ell \rar & 0
	\end{tikzcd}
\end{equation}
where $\Gal(\sepcl K/K)$ acts trivially on $\Z_\ell$. Tensoring with $\Q_\ell$, we
obtain the exact sequence
\begin{equation}
	\begin{tikzcd}
		0 \rar & V_\ell(\mu) \rar & V_\ell(E_n) \rar & \Q_\ell \rar & 0.
	\end{tikzcd}
	\label{cd:IV_A2_3}
\end{equation}
We now show that this sequence of $\Gal(\sepcl K/K)$-modules does not split. To
do this we introduce an invariant $x$ which belongs to the group $\invlim_n
H^1(G, \mu_n)$, where $G = \Gal(\sepcl K/K)$. Let $d$ be the coboundary
homomorphism:
\[
	H^0(G, \Z/\ell^n\Z) \longrightarrow H^1(G, \mu_n)
\]
with respect to the exact sequence \eqref{cd:IV_A2_1} and let $x_n = d(1)$. The
invariant $x$ is the element of $\invlim_n H^1(G, \mu_n)$ defined by the family
$(x_n)_{n \ge 1}$.

\begin{prop}
\begin{enumerate}[(a)]
	\item\label{prop:IV_A2a}
		The isomorphism $\delta \colon K^\times/{K^\times}^{\ell^n} \to
		H^1(G, \mu_n)$ of Kummer theory transforms the class of $q
		\mod{ {K^\times}^{\ell^n} }$ into $x_n$.
	\item\label{prop:IV_A2b}
		The element $x$ is of infinite order.
\end{enumerate}
\end{prop}
(Recall that $\delta$ is induced by the coboundary map relative to
the exact sequence
\[\begin{tikzcd}
	1 \rar & \mu_n \rar & {\algcl K}^\times \rar["()^{\ell^n}"] &
	{\algcl K}^\times \rar & 1.)
\end{tikzcd}\]
\begin{proof}
	Assertion \ref{prop:IV_A2a} is proved by an easy computation. To prove
	\ref{prop:IV_A2b}, note that the valuation $v$ defines a homomorphism
	\[
		f_n \colon K^\times/{K^\times}^{\ell^n} \longrightarrow
		\Z/\ell^n\Z,
	\]
	and hence a homomorphism
	\[
		f \colon \invlim_n K^\times/{K^\times}^{\ell^n} \longrightarrow
		\Z_\ell.
	\]
	If we identify $x$ with the corresponding element of $\invlim
	K^\times/{K^\times}^{\ell^n}$, as in \ref{prop:IV_A2a}, we have $f(x) =
	v(q)$, hence $x$ is of infinite order.
\end{proof}

\begin{corp}
	The sequence \eqref{cd:IV_A2_3} does not split.
\end{corp}
\begin{proof}
	Assume it does, i.e.\ there is a $G$-subspace $X$ of $V_\ell(E_q)$
	which is mapped isomorphically onto $\Q_\ell$. Let $X_T = T_\ell(E_q)
	\cap X$.  The image of $X_T$ in $\Z_\ell$ is $\ell^N\Z_\ell$, for some
	$N \ge 0$. It is then easy to see that $\ell^N x = 0$, and this
	contradicts the fact that $x$ is of
	\dpage
	infinite order.
\end{proof}

\subsubsection{Determination of \texorpdfstring{$\mathfrak{g}_\ell$}{gℓ} and
\texorpdfstring{$\mathfrak{i}_\ell$}{iℓ}}
\label{sec:IV_A13}
We keep the notation of \ref{sec:IV_A11} and \ref{sec:IV_A12}. If $X$ is a
one-dimensional subspace of $V_\ell = V_\ell(E)$, let $\mathfrak{r}_X$ denote
the subalgebra of $\End(V_\ell)$ consisting of those endomorphisms $u$ for
which $u(V_\ell) \subset X$, and let $\mathfrak{n}_X$ be the subalgebra of
$\mathfrak{r}_X$ formed by those $u \in \mathfrak{r}_X$ with $u(X) = 0$.

\begin{thm}
\begin{enumerate}[(a)]
	\item\label{thm:IV_A13a}
		If $k$ is algebraically closed and $\ell \ne p$, then there is a
		one-dimensional subspace $X$ of $V_\ell$ such that
		$\mathfrak{g}_\ell = \mathfrak{n}_X$.
	\item\label{thm:IV_A13b}
		If $k$ is algebraically closed and $\ell = p$, then there is a
		one-dimensional subspace $X$ of $V_\ell$ such that
		$\mathfrak{g}_\ell = \mathfrak{r}_X$.
	\item If $k$ is finite, then $\mathfrak{g}_\ell = \mathfrak{r}_X$ for
		some one-dimensional subspace $X$ of $V_\ell$, and
		$\mathfrak{i}_\ell = \mathfrak{n}_X$ (resp.\ $\mathfrak{i}_\ell
		= \mathfrak{r}_X$) if $\ell \ne p$ (resp.\ $\ell = p$).
\end{enumerate}
\end{thm}
\begin{proof}
Note first that, since $\mathfrak{g}_\ell$ and $\mathfrak{i}_\ell$ are invariant under finite
extension of $K$, we may assume that $E = E_q$.
\begin{enumerate}
	\item In this case, $K$ contains the $\ell^n$-th roots of unity, hence
		$\Gal(\sepcl K/K)$ acts trivially on $T_\ell(\mu)$.
		Consequently, there is a basis $e_1, e_2$ of $T_\ell(E)$ such
		that, for all $\sigma \in \Gal(\sepcl K/K)$, we have
		$\sigma(e_1) = e_1$, $\sigma(e_2) = a(\sigma)e_1 + e_2$ with
		$a(\sigma) \in \Z_\ell$. Moreover, the homomorphism $\sigma
		\mapsto a(\sigma)$ cannot be trivial since the sequence
		\eqref{cd:IV_A2_3} does not split. It follows that $\Img(a)$ is
		an open subgroup of $\Z_\ell$, and hence that
		$\mathfrak{g}_\ell = \mathfrak{n}_X$ with $X = V_\ell(\mu)$.
	\item Since $\ell = p$, we must have $\char(K) = 0$ as $\ell \ne
		\char(K)$.  In this case, the action of $\Gal(\algcl K/K)$ on
		$V_\ell(\mu)$ is by means of the character $\chi_\ell$ (cf.\
		chap.~\ref{ch:i}, \ref{sec:I_12}) which is of infinite order.
		It follows
		\dpage
		that $\mathfrak{g}_\ell = \mathfrak{r}_X$ where $X =
		V_\ell(\mu)$; in fact, $\mathfrak{g}_\ell \supset
		\mathfrak{n}_X$ since the sequence \eqref{cd:IV_A2_3} does not
		split, and we cannot have $\mathfrak{g}_\ell = \mathfrak{n}_X$.
	\item Since $k$ is finite, the action of $\Gal(\sepcl K/K)$ on
		$T_\ell(\mu)$ is not trivial nor even of finite order. Hence,
		the argument used in \ref{thm:IV_A13b} shows that
		$\mathfrak{g}_\ell = \mathfrak{r}_X$. where $X = V_\ell(\mu)$.
		Applying (a) to the completion of the maximal unramified
		extension of $K$, we see that $\mathfrak{i}_\ell =
		\mathfrak{n}_X$ if $\ell \ne p$, and that $\mathfrak{i}_\ell =
		\mathfrak{r}_X$ if $\ell = p$.  \qedhere
\end{enumerate}
\end{proof}

\subsubsection*{Exercise}
In case \ref{thm:IV_A13a}, show that $\Img(a) = \ell^n \Z_\ell$, where $\ell^n$
is the highest power of $\ell$ which divides $v(q) = -v(j)$.

\subsubsection{Application to isogenies}
\label{sec:IV_A14}
\todo[section]{Belén.}

\subsubsection{Existence of transvections in the inertia group}
\label{sec:IV_A15}
\todo[section]{Belén.}

\subsection{The case \texorpdfstring{$v(j) \ge 0$}{v(j) ≥ 0}}
\label{sec:IV_A2}
In this section we assume that the modular invariant $j$ of the elliptic curve
$E$ is integral, i.e.\ that $v(j) \ge 0$. Hence, after possibly replacing $K$
by a finite extension, we may assume that $E$ has \emph{good reduction} (cf.\
\ref{sec:IV_12}). We also assume that \emph{$K$ is of characteristic zero.}

\subsubsection{The case \texorpdfstring{$\ell \ne p$}{ℓ ̸/= p}}
\label{sec:IV_A21}
\todo[section]{Belén.}

\subsubsection{The case \texorpdfstring{$\ell = p$}{ℓ = p} with good
reduction of height 2}
\label{sec:IV_A22}
Here we assume that the reduced curve $\widetilde{E}$ is of height 2; recall
that, if $A$ is an abelian variety defined over a field of characteristic $p$,
its height can be defined as the integer $h$ for which $p$ is the inseparable
part of the degree of the homothety ``multiplication by $p$.'' An elliptic
curve is of height 2 if and only if its \emph{Hasse invariant} (cf.\
\citeauthor{9}~\cite{9}) is 0. Since $E$ has good reduction, it defines an
\emph{abelian scheme} $E(p)$ over $\mathcal{O}_{K'}$, hence a
\emph{$p$-divisible group} $E(p)$ over $\mathcal{O}_K$ (cf.\
\citeauthor{39}~\cite{39}, 2.1 -- see also \cite{26}, \S1, Ex.~2).  The Tate
module of $E(p)$ can be identified with $T_p$. The connected component
$E(p)^\circ$ of $E(p)$ coincides with the \emph{formal group} (over
$\mathcal{O}_K$) attached to $E_v$; the height of $\widetilde{E}$ is precisely
the height of this formal group (in the usual sense). In our case, we have
$E(p) = E(p)^\circ$ since the height is assumed to be 2.

\begin{thm}
	One has $\mathfrak{g}_p = \mathfrak{i}_p$. This Lie algebra is either
	$\End(V_p)$ or a non-split Cartan subalgebra of $\End(V_p)$.
\end{thm}

(Recall that a non-split Cartan subalgebra of $\End(V_p)$ is a commutative
subalgebra of rank 2 with respect to which $V_p$ is irreducible. It is given by
a quadratic subfield of $\End(V_p)$.)
\begin{proof}
	The Lie algebra $\mathfrak{g}_p$ has the property that $\mathfrak{g}_p
	z = V_p$ for any non zero element $z$ of $V_p$ (cf.\ \cite[128]{27},
	Prop.~8). In particular, $V_p$ is an irreducible
	$\mathfrak{g}_p$-module; its commuting algebra is either a field of
	degree 2 (which is then necessarily equal to $\mathfrak{g}_p$) or the
	\dpage
	field $\Q_p$, in which case $\mathfrak{g}_p$ is \emph{a priori} $\Sl_2$
	or $\Gl_2$. But $\mathfrak{g}_p \ne \Sl_2$ since $\bigwedge^2 V_p$ is
	canonically isomorphic to $V_p(\mu)$, and the action of $\Gal(\algcl
	K/K)$ on $V_p(\mu)$ is by means of the character $\chi_p$, which is of
	infinite order (indeed, no finite extension of $K$ can contain all
	$p^n$-th roots of unity, $n = 1, 2, \dots$). Hence the Lie algebra
	$\mathfrak{g}_p$ is either $\End(V_p)$ or a non split Cartan subalgebra
	of $\End(V_p)$. Since the above applies to the completion of the
	maximal unramified extension of $K$, we have the same alternative for
	$\mathfrak{i}_p$. Moreover, $\mathfrak{i}_p$ is contained in
	$\mathfrak{g}_p$. We have \emph{a priori} three possibilities:
	\begin{enumerate}[(a)]
		\item $\mathfrak{i}_p = \mathfrak{g}_p = \End(V_p)$.
		\item $\mathfrak{i}_p = \mathfrak{g}_p$ is a non split Cartan
			subalgebra of $\End(V_p)$.
		\item $\mathfrak{i}_p$ is a Cartan subalgebra and
			$\mathfrak{g}_p = \End(V_p)$.
	\end{enumerate}
	However, $\mathfrak{i}_p$ is an ideal of $\mathfrak{g}_p$. Hence, (c)
	is impossible, and this proves the theorem.
\end{proof}

\begin{obs}
\begin{enumerate}
	\item By a theorem of Tate (\cite{39}, \S4, cor.~1 to th.~4), the
		algebra $\mathfrak{g}_p$ is a Cartan subalgebra of $\End(V_p)$
		if and only if $E(p)$ has ``formal complex multiplication'',
		i.e.\ if and only if the ring of endomorphisms of $E(p)$, over
		a suitable extension of $K$, is of rank 2 over $\Z_p$. There
		exist elliptic curves without complex multiplication (in the
		algebraic sense) whose $p$-completion $E(p)$ have formal
		complex multiplication.
	\item Suppose that $\mathfrak{g}_p$ is a Cartan subalgebra of
		$\End(V_p)$, and let $H = \mathfrak{g}_p \cap \Aut(V_p)$ be the
		corresponding Cartan subgroup of $\Aut(V_p)$. If $N$ is the
		normalizer of $H$ in $\Aut(V_p)$, then one knows that $N/H$ is
		cyclic of order 2. Since $G_p \subset N$, it follows that $G_p$
		is commutative if and only if $G_p \subset H$. The case $G_p
		\subset H$ corresponds to the case where the formal complex
		multiplication of $E(p)$ is
		\dpage
		defined over $K$, and the case $G_p \not\subset H$ corresponds to
		the case where this formal multiplication is defined over a
		quadratic extension of $K$.
	\item Suppose that $G_p$ is commutative, and that the residue field $k$
		is \emph{finite}. Let $F$ be the quadratic field of formal
		complex multiplication (i.e.\ $\mathfrak{g}_p$ itself, viewed
		as an associative subalgebra of $\End(V_p)$). If $U_F$ denotes
		the group of units of $F$, the action of $\Gal(\algcl K/K)$ on
		$V_p$ is given by a homomorphism
		\[
			\varphi_I \colon \Gal(\algcl K/K) \longrightarrow U_F.
		\]
		By local class field theory, we may identify the inertia group
		of $\abcl{\Gal(\algcl K/K)}$ with the group $U_K$ of units of
		$K$. Hence the restriction $\varphi_I$ of $\varphi$ to the
		inertia group is a \emph{homomorphism of $U_K$ into $U_F$}.  To
		determine $\varphi_I$, we first remark that the action of
		$\End(E(p))$ on the tangent space to $E(p)$ defines an
		\emph{embedding} of $F$ into $K$. For that embedding, one has
		(compare with chap.~\ref{ch:iii}, \ref{sec:III_A4})
		\[
			\varphi_I(x) = \Nm_{K/F}(x^{-1}), \qquad \text{for
				all } x\in U_K.
		\]
		Indeed, by a result of Lubin (\emph{Ann. of Math.} 85, 1967),
		\todo[bluetask]{Añadir referencia.}
		there is a formal group $E'$ which is $K$-isogenous to $E(p)$,
		and has for ring of endomorphisms the ring of integers of $F$.
		But then, if $E''$ is a Lubin-Tate group over $K$ (cf.\
		\citeauthor{17}~\cite{17}), the formal groups $E'$ and $E''$
		are isomorphic over the completion of the maximal unramified
		extension of $K$ (cf.\ \citeauthor{16}~\cite{16}, th.~4.3.2).
		Hence to prove the formula (*),
		\todo[bluetask]{¿A qué fórmula se refiere?}
		we may assume that $E(p)$ is a
		Lubin-Tate group, in which case the formula (*) follows from
		the main result of \cite{17}.
\end{enumerate}
\end{obs}

\subsubsection{Auxiliary results on abelian varieties}
\label{sec:IV_A23}
Let $A$ and $B$ be two abelian varieties over $K$,
\dpage
with good reduction, so that the associated $p$-divisible groups $A(p)$ and
$B(p)$ are defined (these are $p$-divisible groups \emph{over the ring
$\mathcal{O}_{K'}$}, cf.\ \citeauthor{39}~\cite{39}). Let $\widetilde{A}$ and
$\widetilde{B}$ (resp.\ $\widetilde{A(p)}$ and $\widetilde{B(p)}$) be the
reductions of $A$ and $B$ (resp.\ of $A(p)$ and $B(p)$).

\begin{thm}\label{thm:IV_A23_1}
	Let $\tilde f \colon \widetilde A \to \widetilde B$ be a morphism of
	abelian varieties, and let $\widetilde{f(p)}$ be the corresponding
	morphism of $\widetilde{A(p)}$ into $\widetilde{B(p)}$.  Assume there
	is a morphism $f(p) \colon A(p) \to B(p)$ whose reduction is
	$\widetilde{f(p)}$. Then, there is a morphism $f \colon A \to B$ whose
	reduction is $f$.
\end{thm}
A proof of this ``lifting'' theorem has been given by Tate in a Seminar (Woods
Hole, 1964), but has not yet been published;
\todo[bluetask]{Añadir referencia}
a different proof has been given by W. Messing (\emph{L. N.} 264, 1972).

\begin{thm}\label{thm:IV_A23_2}
	Assume $T_p(A)$ is a direct sum of $\Z_p$-modules of rank 1 invariant
	under the action of $\Gal(\algcl K/K)$. Then every endomorphism of
	$\widetilde{A}$ lifts to an endomorphism of $A$, i.e., the reduction
	homomorphism $\End(A) \to \End(\widetilde A)$ is surjective (and hence
	bijective, since it is known to be injective).
\end{thm}
Using theorem~\ref{thm:IV_A23_1}, one sees that it is enough to show that any
endomorphism of $\widetilde{A(p)}$ can be lifted to an endomorphism of $A(p)$.
But the assumption made on $T_p$ implies (cf.\ \citeauthor{39}~\cite{39}, 4.2)
that $A(p)$ is a product of $p$-divisible groups of height 1. Hence we are
reduced to proving the following elementary result:

\begin{lem}
	Let $H_1$, $H_2$ be two $p$-divisible groups, over $\mathcal{O}_{K'}$
	both of height one. Then the reduction map: $\Hom(H_1, H_2) \to
	\Hom(\widetilde{H}_1, \widetilde{H}_2)$ is bijective.
\end{lem}
\begin{proof}
	This is clear if both $H_1$ and $H_2$ are étale.
	\dpage
	If both are not étale, their duals are étale and we are reduced to the
	previous case.  If one of them is étale, and the other is not, one
	checks readily that
	\begin{equation}
		\Hom(H_1, H_2) = \Hom(\widetilde{H}_1, \widetilde{H}_2) = 0.
		\tqedhere
	\end{equation}
\end{proof}

\begin{corl}
	Assume:
	\begin{enumerate}[(i)]
		\item\label{cor:IV_23i}
			$V_p(A)$ is a direct sum of one-dimensional subspaces
			stable under $\Gal(\algcl K/K)$.
		\item\label{cor:IV_23ii}
			The residue field $k$ of $K$ is finite.
	\end{enumerate}
	Then $A$ is isogenous to a product of abelian varieties of (CM) type (m
	the sense of \citeauthor{34}~\cite{34}, cf.\ also chap.~\ref{ch:ii},
	\ref{sec:II_28}).
\end{corl}
\begin{proof}
	Assumption \ref{cor:IV_23i} implies that $T_p(A)$ contains a lattice
	$T'$ which is a direct sum of free $\Z_p$-modules of rank 1 stable
	under $\Gal(\algcl K/K)$. One can find an isogeny $A_1 \to A$ such that
	$T_p(A_1)$ is mapped onto $T'$. This means that, after replacing $A$ by
	an isogenous variety, we may apply Th.~\ref{thm:IV_A23_2} to $A$, i.e.\
	$\End(A) \to \End(\widetilde A)$ is an isomorphism. But, since $k$ is
	finite, it follows from a result of \citeauthor{38}~\cite{38} that $\Q
	\otimes \End(\widetilde A)$ contains a semi-simple commutative\break
	$\Q$-subalgebra $\Lambda$ of rank $2 \dim(A)$ (this is not explicitly
	stated in \cite{38}, but follows easily from its ``Main Theorem'').
	Hence, the same is true for $\Q \otimes \End(A)$. If we now write
	$\Lambda$ as a product of commutative fields $\Lambda_\alpha$, one sees
	that $A$ is isogenous to a product $\prod_{\alpha} A_\alpha$, where
	$A_\alpha$ has complex multiplication of type $\Lambda_\alpha$.
\end{proof}

\subsubsection{The case \texorpdfstring{$\ell = p$}{ℓ = p} with good reduction
of height 1}
\label{sec:IV_A24}
\todo[section]{Belén.}

\end{subappendices}
